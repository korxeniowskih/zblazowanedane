CREATE TABLE "roles" (
  "id" BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  "code" varchar(64) UNIQUE NOT NULL,
  "name" varchar(128) NOT NULL
);

CREATE TABLE "movie_genres" (
  "id" BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  "name" varchar(128) UNIQUE NOT NULL
);

CREATE TABLE "employees" (
  "id" BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  "first_name" varchar(100) NOT NULL,
  "last_name" varchar(100) NOT NULL,
  "email" varchar(255) UNIQUE,
  "phone" varchar(50),
  "hire_date" date NOT NULL,
  "active" boolean NOT NULL DEFAULT true,
  "created_at" timestamp NOT NULL DEFAULT (CURRENT_TIMESTAMP)
);

CREATE TABLE "employee_roles" (
  "employee_id" bigint NOT NULL,
  "role_id" bigint NOT NULL,
  "from_date" date NOT NULL,
  "to_date" date,
  "is_primary" boolean NOT NULL DEFAULT false,
  PRIMARY KEY ("employee_id", "role_id", "from_date")
);

CREATE TABLE "customers" (
  "id" BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  "first_name" varchar(100) NOT NULL,
  "last_name" varchar(100) NOT NULL,
  "email" varchar(255) UNIQUE,
  "password" varchar(255) NOT NULL,
  "phone" varchar(50),
  "created_at" timestamp NOT NULL DEFAULT (CURRENT_TIMESTAMP)
);

CREATE TABLE "movies" (
  "id" BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  "title" varchar(300) NOT NULL,
  "movie_genre_id" bigint NOT NULL,
  "release_date" date,
  "runtime_min" int,
  "rating" varchar(20),
  "description" text,
  "created_at" timestamp NOT NULL DEFAULT (CURRENT_TIMESTAMP)
);

CREATE TABLE "halls" (
  "id" BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  "name" varchar(64) UNIQUE NOT NULL,
  "capacity" int NOT NULL,
  "is_3d" boolean NOT NULL DEFAULT false,
  "is_imax" boolean NOT NULL DEFAULT false,
  "wheelchair_access" boolean NOT NULL DEFAULT true
);

CREATE TABLE "seats" (
  "id" BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  "hall_id" bigint NOT NULL,
  "row_label" varchar(10) NOT NULL,
  "seat_number" int NOT NULL,
  "seat_type" varchar(32) NOT NULL DEFAULT 'standard'
);

CREATE TABLE "screenings" (
  "id" BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  "movie_id" bigint NOT NULL,
  "hall_id" bigint NOT NULL,
  "start_time" timestamp NOT NULL,
  "end_time" timestamp NOT NULL,
  "language" varchar(32) NOT NULL DEFAULT 'original',
  "is_3d" boolean NOT NULL DEFAULT false,
  "base_price_cents" int NOT NULL,
  "status" varchar(20) NOT NULL DEFAULT 'scheduled'
);

CREATE TABLE "reservations" (
  "id" BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  "customer_id" bigint NOT NULL,
  "screening_id" bigint NOT NULL,
  "status" varchar(20) NOT NULL DEFAULT 'pending',
  "created_at" timestamp NOT NULL DEFAULT (CURRENT_TIMESTAMP),
  "expires_at" timestamp
);

CREATE TABLE "reservation_seats" (
  "reservation_id" bigint NOT NULL,
  "seat_id" bigint NOT NULL,
  "price_cents" int NOT NULL,
  PRIMARY KEY ("reservation_id", "seat_id")
);

CREATE TABLE "tickets" (
  "id" BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  "screening_id" bigint NOT NULL,
  "seat_id" bigint NOT NULL,
  "customer_id" bigint,
  "reservation_id" bigint,
  "price_cents" int NOT NULL,
  "status" varchar(20) NOT NULL DEFAULT 'sold',
  "sold_at" timestamp NOT NULL DEFAULT (CURRENT_TIMESTAMP),
  "seller_employee_id" bigint
);

CREATE TABLE "shifts" (
  "id" BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  "hall_id" bigint,
  "role_id" bigint,
  "start_time" timestamp NOT NULL,
  "end_time" timestamp NOT NULL,
  "supervisor_id" bigint
);

CREATE TABLE "shift_assignments" (
  "shift_id" bigint NOT NULL,
  "employee_id" bigint NOT NULL,
  "role_id" bigint,
  PRIMARY KEY ("shift_id", "employee_id")
);

CREATE UNIQUE INDEX "seats_index_1" ON "seats" ("hall_id", "row_label", "seat_number");

CREATE UNIQUE INDEX "tickets_index_2" ON "tickets" ("screening_id", "seat_id");

ALTER TABLE "employee_roles" ADD FOREIGN KEY ("employee_id") REFERENCES "employees" ("id");

ALTER TABLE "employee_roles" ADD FOREIGN KEY ("role_id") REFERENCES "roles" ("id");

ALTER TABLE "movies" ADD FOREIGN KEY ("movie_genre_id") REFERENCES "movie_genres" ("id");

ALTER TABLE "seats" ADD FOREIGN KEY ("hall_id") REFERENCES "halls" ("id");

ALTER TABLE "screenings" ADD FOREIGN KEY ("movie_id") REFERENCES "movies" ("id");

ALTER TABLE "screenings" ADD FOREIGN KEY ("hall_id") REFERENCES "halls" ("id");

ALTER TABLE "reservations" ADD FOREIGN KEY ("customer_id") REFERENCES "customers" ("id");

ALTER TABLE "reservations" ADD FOREIGN KEY ("screening_id") REFERENCES "screenings" ("id");

ALTER TABLE "reservation_seats" ADD FOREIGN KEY ("reservation_id") REFERENCES "reservations" ("id");

ALTER TABLE "reservation_seats" ADD FOREIGN KEY ("seat_id") REFERENCES "seats" ("id");

ALTER TABLE "tickets" ADD FOREIGN KEY ("screening_id") REFERENCES "screenings" ("id");

ALTER TABLE "tickets" ADD FOREIGN KEY ("seat_id") REFERENCES "seats" ("id");

ALTER TABLE "tickets" ADD FOREIGN KEY ("customer_id") REFERENCES "customers" ("id");

ALTER TABLE "tickets" ADD FOREIGN KEY ("reservation_id") REFERENCES "reservations" ("id");

ALTER TABLE "tickets" ADD FOREIGN KEY ("seller_employee_id") REFERENCES "employees" ("id");

ALTER TABLE "shifts" ADD FOREIGN KEY ("hall_id") REFERENCES "halls" ("id");

ALTER TABLE "shifts" ADD FOREIGN KEY ("role_id") REFERENCES "roles" ("id");

ALTER TABLE "shifts" ADD FOREIGN KEY ("supervisor_id") REFERENCES "employees" ("id");

ALTER TABLE "shift_assignments" ADD FOREIGN KEY ("shift_id") REFERENCES "shifts" ("id");

ALTER TABLE "shift_assignments" ADD FOREIGN KEY ("employee_id") REFERENCES "employees" ("id");

ALTER TABLE "shift_assignments" ADD FOREIGN KEY ("role_id") REFERENCES "roles" ("id");


CREATE OR REPLACE VIEW view_customer_tickets AS
SELECT
t.id AS ticket_id,
c.id AS customer_id,
c.first_name || ' ' || c.last_name AS customer_name,
m.title AS movie_title,
h.name AS hall_name,
sc.start_time,
sc.end_time,
t.price_cents,
t.status,
s.row_label,
s.seat_number
FROM tickets t
LEFT JOIN customers c ON t.customer_id = c.id
LEFT JOIN screenings sc ON t.screening_id = sc.id
LEFT JOIN movies m ON sc.movie_id = m.id
LEFT JOIN halls h ON sc.hall_id = h.id
LEFT JOIN seats s ON t.seat_id = s.id;